@model Account.Controllers.UsersController.UserIndexVM
@{
    string sort = (ViewBag.Sort as string) ?? "id";
    string dir = (ViewBag.Dir as string) ?? "desc";
    string Next(string key) => (sort == key && dir == "asc") ? "desc" : "asc";
    string Arrow(string key) => sort == key ? (dir == "asc" ? "↑" : "↓") : "";
}

<div class="table-responsive">
    <table class="table table-striped table-hover table-sm align-middle">
        <thead>
            <tr>
                <th>
                    <a class="text-dark text-decoration-none ajax-link"
                       asp-action="List" asp-route-sort="id" asp-route-dir="@Next("id")"
                       asp-route-keyword="@Model.Keyword" asp-route-status="@Model.Status"
                       asp-route-page="@Model.Page" asp-route-pageSize="@Model.PageSize"># @Arrow("id")</a>
                </th>
                <th>
                    <a class="text-dark text-decoration-none ajax-link"
                       asp-action="List" asp-route-sort="email" asp-route-dir="@Next("email")"
                       asp-route-keyword="@Model.Keyword" asp-route-status="@Model.Status"
                       asp-route-page="@Model.Page" asp-route-pageSize="@Model.PageSize">Email @Arrow("email")</a>
                </th>
                <th>
                    <a class="text-dark text-decoration-none ajax-link"
                       asp-action="List" asp-route-sort="phone" asp-route-dir="@Next("phone")"
                       asp-route-keyword="@Model.Keyword" asp-route-status="@Model.Status"
                       asp-route-page="@Model.Page" asp-route-pageSize="@Model.PageSize">電話 @Arrow("phone")</a>
                </th>
                <th>
                    <a class="text-dark text-decoration-none ajax-link"
                       asp-action="List" asp-route-sort="status" asp-route-dir="@Next("status")"
                       asp-route-keyword="@Model.Keyword" asp-route-status="@Model.Status"
                       asp-route-page="@Model.Page" asp-route-pageSize="@Model.PageSize">狀態 @Arrow("status")</a>
                </th>
                <th>類型</th>
                <th>最近登入</th>
                <th style="width:180px;"></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var x in Model.Items)
            {
                var statusText = x.Status switch { 0 => "未啟用", 1 => "啟用", 2 => "停用", _ => "?" };
                var badge = x.Status switch { 1 => "bg-success", 2 => "bg-secondary", _ => "bg-light text-dark" };
                var typeText = x.UserType switch { 2 => "員工", 3 => "書商", 1 => "顧客", _ => "?" };
                <tr>
                    <td>@x.UserID</td>
                    <td>@x.Email</td>
                    <td>@x.Phone</td>
                    <td><span class="badge @badge">@statusText</span></td>
                    <td>@typeText</td>
                    <td>@(x.LastLoginAt?.ToLocalTime().ToString("yyyy/MM/dd HH:mm") ?? "-")</td>
                    <td class="text-end">
                        <a class="btn btn-sm btn-outline-secondary" asp-action="Details" asp-route-id="@x.UserID">檢視</a>
                        @if (User.HasClaim("perm", "Accounts.Edit"))
                        {
                            <a class="btn btn-sm btn-outline-primary ms-1" asp-action="Edit" asp-route-id="@x.UserID">編輯</a>
                            <a class="btn btn-sm btn-outline-danger ms-1" asp-action="Delete" asp-route-id="@x.UserID">刪除</a>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@{
    int totalPages = (int)Math.Ceiling((double)Model.Total / Model.PageSize);
    if (totalPages < 1) totalPages = 1;
    int window = 2;
    int start = Math.Max(1, Model.Page - window);
    int end = Math.Min(totalPages, Model.Page + window);
}

<nav aria-label="pager">
    <ul class="pagination">
        <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
            <a class="page-link ajax-link"
               asp-action="List" asp-route-page="@(Model.Page - 1)"
               asp-route-pageSize="@Model.PageSize" asp-route-keyword="@Model.Keyword"
               asp-route-status="@Model.Status" asp-route-sort="@sort" asp-route-dir="@dir">上一頁</a>
        </li>
        @for (int i = start; i <= end; i++)
        {
            <li class="page-item @(i == Model.Page ? "active" : "")">
                <a class="page-link ajax-link"
                   asp-action="List" asp-route-page="@i"
                   asp-route-pageSize="@Model.PageSize" asp-route-keyword="@Model.Keyword"
                   asp-route-status="@Model.Status" asp-route-sort="@sort" asp-route-dir="@dir">@i</a>
            </li>
        }
        <li class="page-item @(Model.Page >= totalPages ? "disabled" : "")">
            <a class="page-link ajax-link"
               asp-action="List" asp-route-page="@(Model.Page + 1)"
               asp-route-pageSize="@Model.PageSize" asp-route-keyword="@Model.Keyword"
               asp-route-status="@Model.Status" asp-route-sort="@sort" asp-route-dir="@dir">下一頁</a>
        </li>
    </ul>
</nav>
