@model IEnumerable<ExportLogVM>
@{
    ViewData["Title"] = "匯出/寄送紀錄";
    string Badge(string fmt) => fmt == "xlsx" ? "success" : (fmt == "pdf" ? "danger" : "secondary");
    string StatusText(byte s) => s switch { 1 => "Sent", 2 => "Failed", _ => s.ToString() };
    string StatusBadge(byte s) => s switch { 1 => "success", 2 => "danger", _ => "secondary" };
    var sizeMap = ViewBag.SizeMap as IDictionary<long, string>; // 由 Controller 提供：ExportID -> "x.xx KB/MB"
}

<h2 class="mb-3">匯出/寄送紀錄</h2>

<form method="get" class="row g-2 mb-3">
    <div class="col-auto"><input name="email" class="form-control form-control-sm" placeholder="Email" value="@Context.Request.Query["email"]"></div>
    <div class="col-auto"><input name="userId" class="form-control form-control-sm" placeholder="UserID" value="@Context.Request.Query["userId"]"></div>
    <div class="col-auto"><input name="supplierId" class="form-control form-control-sm" placeholder="SupplierID" value="@Context.Request.Query["supplierId"]"></div>
    <div class="col-auto"><input name="definitionId" class="form-control form-control-sm" placeholder="DefinitionID" value="@Context.Request.Query["definitionId"]"></div>
    <div class="col-auto">
        <select name="format" class="form-select form-select-sm">
            <option value="">(格式)</option>
            <option value="xlsx" selected="@(Context.Request.Query["format"] == "xlsx")">xlsx</option>
            <option value="pdf" selected="@(Context.Request.Query["format"] == "pdf")">pdf</option>
        </select>
    </div>
    <div class="col-auto">
        <select name="status" class="form-select form-select-sm">
            <option value="">(狀態)</option>
            <option value="1" selected="@(Context.Request.Query["status"] == "1")">1 Sent</option>
            <option value="2" selected="@(Context.Request.Query["status"] == "2")">2 Failed</option>
        </select>
    </div>
    <div class="col-auto"><input type="date" name="from" class="form-control form-control-sm" value="@Context.Request.Query["from"]"></div>
    <div class="col-auto"><input type="date" name="to" class="form-control form-control-sm" value="@Context.Request.Query["to"]"></div>
    <div class="col-auto"><button class="btn btn-sm btn-primary">查詢</button></div>
</form>

<table class="table table-sm table-striped align-middle">
    <thead class="table-light">
        <tr>
            <th style="width:70px">ID</th>
            <th>時間</th>
            <th>格式/狀態</th>
            <th>Email</th>
            <th>檔名 / 大小</th>
            <th>名稱</th>
            <th>書商</th>
            <th>定義</th>
            <th style="width:60px"></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var r in Model)
        {
            var sizeText = (sizeMap != null && sizeMap.ContainsKey(r.ExportID))
            ? sizeMap[r.ExportID]
            : (r.AttachmentBytes + " B");

            <tr>
                <td class="text-muted">@r.ExportID</td>
                <td><span title="@r.RequestedAt.ToString("O")">@r.RequestedAt.ToString("yyyy/MM/dd HH:mm:ss")</span></td>
                <td>
                    <span class="badge bg-@Badge(r.Format)">@r.Format</span>
                    <span class="badge bg-@StatusBadge(r.Status)">@StatusText(r.Status)</span>
                </td>
                <td><a href="mailto:@r.TargetEmail">@r.TargetEmail</a></td>
                <td>
                    <div class="small text-truncate" style="max-width:240px" title="@r.AttachmentFileName">@r.AttachmentFileName</div>
                    <div class="text-muted small">@sizeText</div>
                </td>
                <td>
                    <div class="fw-semibold text-truncate" style="max-width:220px" title="@r.ReportName">@r.ReportName</div>
                    <div class="text-muted small">@r.Category</div>
                </td>
                <td>@(r.SupplierID?.ToString() ?? "-")</td>
                <td>@(r.DefinitionID?.ToString() ?? "-")</td>
                <td><a class="btn btn-sm btn-outline-secondary" href="@Url.Action("Details", new { id = r.ExportID })">詳</a></td>
            </tr>
        }
    </tbody>
</table>
