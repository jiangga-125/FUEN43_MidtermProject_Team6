@model IEnumerable<BorrowSystem.ViewModels.ReservationsViewmodel>
@using BorrowSystem.ViewModels

@{
    ViewData["Title"] = "預約";
}

<div id="tableToolbar" class="d-flex align-items-center gap-3 mb-2">
    <div class="d-flex align-items-center">
        <label for="memberFilter" class="form-label mb-0 me-2">預約人</label>
        <select id="memberFilter" class="form-select form-select-sm d-inline-block" style="width:auto;">
            <option value="">全部預約人</option>
        </select>
    </div>
</div>

<table class="table table-striped table-bordered" id="redatatable">
    <thead>
        <tr>
			<th>
                @Html.DisplayNameFor(model => model.BookTitle)
			</th>
			<th>
                @Html.DisplayNameFor(model => model.MemberName)
			</th>
            <th>
                @Html.DisplayNameFor(model => model.ReservationDay)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.ExpiresDay)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.ReadyDay)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.ReservationStatus)
            </th>           
            
            <th>功能</th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model) {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.BookTitle)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.MemberName)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.ReservationDay)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.ExpiresDay)
            </td>
            <td>
                 @Html.DisplayFor(modelItem => item.ReadyDay)
            </td>
            <td>
                 @* @Html.DisplayFor(modelItem => item.ReservationStatus) *@
                    @{
                        // 依 enum 值決定 CSS
                        var statusCss = item.ReservationStatus switch
                        {
                            ReservationStatus.Reserved => "status-reserved",   // 預約中
                            ReservationStatus.Wait => "status-wait",       // 等待取書
                            ReservationStatus.AutoExpired => "status-expired",    // 逾期取消
                            ReservationStatus.Cancelled => "status-cancelled",  // 手動取消
                            ReservationStatus.Complete => "status-done",       // 借閱完成
                            _ => "bg-secondary"
                        };
                    }
                    <span class="badge text-white badge-status @statusCss">
                        @Html.DisplayFor(m => item.ReservationStatus)
                        @* 這裡會自動顯示 enum 的 Display(Name) 中文 *@
                    </span>

            </td>
                <td>
                    @* 僅當狀態為「預約中」時才顯示取消按鈕 *@
                    @if (item.ReservationStatus == (byte)ReservationStatus.Reserved)
                    {
                        @* <form asp-action="Cancel" method="post" class="d-inline">
                            <input type="hidden" name="id" value="@item.ReservationID" />
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-danger btn-sm"
                                    onclick="return confirm('確定要取消這筆預約嗎？');">
                                取消
                            </button>
                        </form> *@
                        <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#CancelReservationModal-@item.ReservationID">
                            取消
                        </button>
                        <div class="modal fade" id="CancelReservationModal-@item.ReservationID" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header bg-danger text-white">
                                        <h5 class="modal-title">系統確認</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        確定要取消這筆預約嗎？
                                    </div>
                                    <div class="modal-footer">
                                        <form asp-action="Cancel" method="post" class="d-inline">
                                            <input type="hidden" name="id" value="@item.ReservationID" />
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-success">確定</button>
                                        </form>
                                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    @* 當狀態為 Wait 時 → 顯示可借出 *@
                    @if (item.ReservationStatus == ReservationStatus.Wait)
                    {
                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#borrowConfirmModal-@item.ReservationID">
                            待取書可借出
                        </button>
                        <!-- Modal -->
                        <div class="modal fade" id="borrowConfirmModal-@item.ReservationID" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header bg-success text-white">
                                        <h5 class="modal-title">系統確認</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        確定要將此書借出給預約者嗎？
                                    </div>
                                    <div class="modal-footer">                                       
                                        <form asp-action="AdminBorrowFromReservation" method="post" class="d-inline">
                                            <input type="hidden" name="reservationId" value="@item.ReservationID" />
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-success">確定</button>
                                        </form>
                                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </td>
        </tr>
}
    </tbody>
</table>
@await Html.PartialAsync("_MessageModal")
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
            window.setTimeout(function () {
            $(".auto-dismiss").fadeTo(500, 0).slideUp(500, function () {
                $(this).remove();
            });
        }, 3000);


          $(function () {
          var table = $('#redatatable').DataTable({
            language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json",
            searchPlaceholder: "輸入書名"  },// 搜尋框的 placeholder
            pageLength: 10,
            lengthMenu: [5, 10, 15],
            ordering: true,
            searching: true,
            columnDefs: [
              { targets: -1, orderable: false, searchable: false } // 最後一欄「功能」不排序不搜尋
            ],
            order: [[2, 'desc']], // 預設以預約日期(第3欄)排序
            initComplete: function () {
              var api = this.api();
              var memberCol = api.column(1); // 第2欄：MemberName

              var $wrapper = $(api.table().container()); // 等同 #redatatable_wrapper
              $wrapper.find('.dataTables_length').appendTo('#tableToolbar');
              // 收集唯一值填入下拉
              var $select = $('#memberFilter');
              var names = [];
              memberCol.data().each(function (d) {
                var text = $('<div>').html(d).text().trim(); // 去掉可能的 HTML
                if (text) names.push(text);
              });
              names = Array.from(new Set(names)).sort();

              names.forEach(function (n) {
                $select.append($('<option/>', { value: n, text: n }));
              });

              // 綁定下拉事件
              $select.on('change', function () {
                var val = $.fn.dataTable.util.escapeRegex($(this).val());
                memberCol.search(val ? '^' + val + '$' : '', true, false).draw();
              });
            }
          });
        });

    
    </script>
}
@section Styles{
    <style>
		.modal-footer {
			border-top: none !important;
		}
        /* 表格 hover */
        #redatatable tbody tr:hover {
            background-color: #f9f9f9;
        }

        /* 狀態顏色 */
        .badge-status {
            font-size: .85rem;
        }

        .status-reserved {
            background-color: #0d6efd;
        }
        /* 預約中 */
        .status-wait {
            background-color: #198754;
        }
        /* 待取書 */
        .status-expired {
            background-color: #dc3545;
        }
        /* 逾期 */
        .status-cancelled {
            background-color: #6c757d;
        }
        /* 已取消 */
        .status-done {
            background-color: #20c997;
        }
        /* 已完成 */
        /* 奇數列 */
        #redatatable tbody tr:nth-child(odd) {
            background-color: #e2e3f3;
        }

        /* 偶數列 */
        #redatatable tbody tr:nth-child(even) {
            background-color: #d1ecf1;
        }

        #redatatable tbody tr:hover {
            background-color: #ffe082 !important; /* 亮橘黃 */
            box-shadow: inset 0 0 5px rgba(0,0,0,.2);
            transition: background-color 0.2s ease;
        }
    </style>    
}
