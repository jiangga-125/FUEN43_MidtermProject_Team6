@model BorrowSystem.ViewModels.BorrowRecordsViewModel

@{
    ViewData["Title"] = "借書";
}

<h1>借閱書籍資訊</h1>



<div class="row">
    <div class="col-md-4">
        <form asp-action="Create" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="ListingID" />
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>         
            <div class="mb-3 d-flex gap-2 align-items-center">
                <label class="form-label text-nowrap text-center">書名</label>
                <input class="form-control" value="@Model.BookTitle" readonly />               
            </div>
            <div class="mb-3 d-flex gap-2 align-items-center">
                <label class="form-label text-nowrap text-center">作者</label>
                <input class="form-control" value="@string.Join(", ", Model.AuthorNames)" readonly />                
            </div>
            <div class="mb-3 d-flex gap-2 align-items-center">
                <label asp-for="MemberID" class="form-label text-nowrap text-center">選擇借閱者</label>
                <select asp-for="MemberID" asp-items="Model.Members" class="form-select">
                    <option value="">-- 請選擇 --</option>                
                </select>
                <span asp-validation-for="MemberID" class="text-danger"></span>
            </div> 
            <div class="mb-3 d-flex gap-2 align-items-center">
                <label asp-for="BorrowDate" class="form-label text-nowrap text-center">借閱日</label>
                <input asp-for="BorrowDate" class="form-control" type="date" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                <span asp-validation-for="BorrowDate" class="text-danger"></span>
            </div>

            <div class="mb-3 d-flex gap-2 align-items-center">
                <label asp-for="DueDate" class="form-label text-nowrap text-center">應還日</label>
                <input asp-for="DueDate" class="form-control" type="date" readonly/>
                <span asp-validation-for="DueDate" class="text-danger"></span>
                
            </div>

            <button type="submit" class="btn btn-primary ">確認借閱</button>
            <a asp-controller="Listings" asp-action="Index" class="btn btn-success ms-3">返回</a>
        </form>
    </div>
</div>



@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
                (function () {
                    // 由 TagHelper 產生的 id 預設就是屬性名稱
                    const $borrow = document.getElementById('BorrowDate');
                    const $due = document.getElementById('DueDate');
                    const LOAN_DAYS = 14;

                    function toYMD(d) {
                        // 轉成 yyyy-MM-dd（HTML date input 需要此格式）
                        const tz = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
                        return tz.toISOString().slice(0, 10);
                    }

                    function syncDue() {
                        if (!$borrow.value) return;
                        const bd = new Date($borrow.value);
                        const dd = new Date(bd);
                        dd.setDate(dd.getDate() + LOAN_DAYS);
                        $due.value = toYMD(dd);

                        // 應還日最小值 = 借閱日
                        $due.min = toYMD(bd);
                    }

                    // 初始載入與變更時同步
                    document.addEventListener('DOMContentLoaded', syncDue);
                    $borrow.addEventListener('change', syncDue);

                    // 頁面載入時若 BorrowDate 沒值，就給今天並同步
                    if (!$borrow.value) {
                        const today = new Date();
                        $borrow.value = toYMD(today);
                        syncDue();
                    }
                })();


    </script>
}
