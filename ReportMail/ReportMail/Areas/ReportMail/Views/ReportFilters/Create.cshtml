@model ReportMail.Data.Entities.ReportFilter
@{
    ViewData["Title"] = "新增篩選欄位";

    var postTemplateUrl = Url.Action("CreateFromTemplate", "FilterTemplates", new { area = "ReportMail" });
    var getCategoryUrlBase = Url.Action("GetCategory", "ReportDefinitionsApi", new { area = "ReportMail", id = 0 })?.Replace("0", "") ?? "/ReportMail/ReportDefinitionsApi/GetCategory/";
}

<h1 class="mb-3">新增篩選欄位</h1>

<div class="row">
    <!-- 左：原 Scaffold 表單（保留） -->
    <div class="col-md-6">
        <form asp-area="ReportMail" asp-controller="ReportFilters" asp-action="Create" method="post">
            @Html.AntiForgeryToken()
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="mb-3">
                <label class="form-label">報表</label>
                <select asp-for="ReportDefinitionID" class="form-select" asp-items="ViewBag.ReportDefinitionID"></select>
                <span asp-validation-for="ReportDefinitionID" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label class="form-label">欄位代號 (FieldName)</label>
                <input asp-for="FieldName" class="form-control" />
                <span asp-validation-for="FieldName" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label class="form-label">顯示名稱 (DisplayName)</label>
                <input asp-for="DisplayName" class="form-control" />
                <span asp-validation-for="DisplayName" class="text-danger"></span>
            </div>

            <div class="row">
                <div class="col">
                    <label class="form-label">資料型別 (DataType)</label>
                    <select asp-for="DataType" class="form-select">
                        <option value="date">date</option>
                        <option value="select">select</option>
                        <option value="number">number</option>
                        <option value="text">text</option>
                    </select>
                    <span asp-validation-for="DataType" class="text-danger"></span>
                </div>
                <div class="col">
                    <label class="form-label">運算子 (Operator)</label>
                    <select asp-for="Operator" class="form-select">
                        <option value="between">between</option>
                        <option value="in">in</option>
                        <option value="=">=</option>
                        <option value=">">&gt;</option>
                        <option value="<">&lt;</option>
                    </select>
                    <span asp-validation-for="Operator" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3 mt-3">
                <label class="form-label">預設值 (DefaultValue)</label>
                <input asp-for="DefaultValue" class="form-control" />
                <span asp-validation-for="DefaultValue" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label class="form-label">選項 (Options, JSON)</label>
                <textarea asp-for="Options" class="form-control" rows="3" placeholder='例如：{"granularity":["day","month","year"]}'></textarea>
                <span asp-validation-for="Options" class="text-danger"></span>
            </div>

            <div class="row">
                <div class="col">
                    <label class="form-label">排序 (OrderIndex)</label>
                    <input asp-for="OrderIndex" class="form-control" value="1" />
                    <span asp-validation-for="OrderIndex" class="text-danger"></span>
                </div>
                <div class="col">
                    <label class="form-label d-block">是否必填</label>
                    <input class="form-check-input" type="checkbox" asp-for="IsRequired" />
                </div>
                <div class="col">
                    <label class="form-label d-block">啟用</label>
                    <input class="form-check-input" type="checkbox" asp-for="IsActive" checked />
                </div>
            </div>

            <div class="mt-3">
                <button type="submit" class="btn btn-primary">建立</button>
                <a asp-area="ReportMail" asp-controller="ReportFilters" asp-action="Index" class="btn btn-secondary">返回列表</a>
            </div>
        </form>
    </div>

    <!-- 右：一鍵模板 -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <strong>快速模板</strong>
                <small class="text-muted ms-2">依報表類型顯示</small>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <label class="form-label">已選報表：</label>
                    <span id="selectedReportInfo" class="text-muted">尚未選擇</span>
                </div>

                <!-- 折線圖 -->
                <div id="tpl-line" class="d-none">
                    <div class="mb-2 fw-bold">折線圖</div>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary" data-preset="line.sales">書籍銷售量（本）：日期顆粒度＋種類＋價位</button>
                        <button type="button" class="btn btn-outline-primary" data-preset="line.borrow">書籍借閱量（本）：日期顆粒度＋種類＋出版年份(10年)</button>
                    </div>
                </div>

                <!-- 長條圖 -->
                <div id="tpl-bar" class="d-none mt-3">
                    <div class="mb-2 fw-bold">長條圖</div>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-success" data-preset="bar.sales">銷售量排行：日期範圍＋名次區間＋種類＋價位</button>
                        <button type="button" class="btn btn-outline-success" data-preset="bar.borrow">借閱量排行：日期範圍＋名次區間＋種類＋出版年份(10年)</button>
                    </div>
                </div>

                <!-- 圓餅圖 -->
                <div id="tpl-pie" class="d-none mt-3">
                    <div class="mb-2 fw-bold">圓餅圖</div>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-warning" data-preset="pie.sales">銷售量組成：日期範圍＋名次區間＋種類＋價位</button>
                        <button type="button" class="btn btn-outline-warning" data-preset="pie.borrow">借閱量組成：日期範圍＋名次區間＋種類＋出版年份(10年)</button>
                    </div>
                </div>

                <hr />
                <form id="tplForm" method="post" action="@postTemplateUrl">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="reportDefinitionId" id="tplReportId" />
                    <input type="hidden" name="preset" id="tplPreset" />
                    <button id="tplSubmit" type="submit" class="btn btn-primary d-none">送出模板</button>
                </form>

                <div class="text-muted mt-3" style="font-size:.9em;">
                    點選上方任一模板，系統會一次建立對應的篩選欄位（含排序與選項）。
                    你仍可之後再到「編輯」做微調。
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function(){
          const ddl = document.getElementById('ReportDefinitionID');
          const info = document.getElementById('selectedReportInfo');
          const tplReportId = document.getElementById('tplReportId');
          const tplPreset = document.getElementById('tplPreset');
          const tplSubmit = document.getElementById('tplSubmit');

          // 送出模板
          document.querySelectorAll('[data-preset]').forEach(btn=>{
            btn.addEventListener('click', ()=>{
              const id = ddl.value;
              if(!id){ alert('請先選擇報表'); return; }
              tplReportId.value = id;
              tplPreset.value = btn.getAttribute('data-preset') || '';
              tplSubmit.click();
            });
          });

          // 依選取報表顯示對應模板群組
          async function refreshCategory(){
            const id = ddl.value;
            tplReportId.value = id || '';
            info.textContent = id ? `ID=${id}` : '尚未選擇';

            ['tpl-line','tpl-bar','tpl-pie'].forEach(x=>document.getElementById(x).classList.add('d-none'));
            if(!id) return;

            try{
              const res = await fetch('@getCategoryUrlBase' + id);
              const js = await res.json();
              const cat = (js?.category || '').toLowerCase();
              if(cat === 'line') document.getElementById('tpl-line').classList.remove('d-none');
              else if(cat === 'bar') document.getElementById('tpl-bar').classList.remove('d-none');
              else if(cat === 'pie') document.getElementById('tpl-pie').classList.remove('d-none');
            }catch(e){ console.warn('GetCategory failed', e); }
          }

          ddl && ddl.addEventListener('change', refreshCategory);
          refreshCategory();
        })();
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
