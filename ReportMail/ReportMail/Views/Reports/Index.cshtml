@{
    ViewData["Title"] = "報表圖形化檢視";
    // ViewBag.ReportDefs 來自 Controller：請確保是 ReportDefinitions 的清單
}
<h2 class="mb-3">報表圖形化檢視</h2>

<form id="runForm" class="row g-2 mb-3">
    <div class="col-auto">
        <select id="reportId" class="form-select">
            @* 依你的實體欄位調整：ReportDefinitionId / ReportName *@
            @foreach (var r in (IEnumerable<dynamic>)ViewBag.ReportDefs)
            {
                <option value="@r.Value">@r.Text</option>
            }
        </select>
    </div>
    <div class="col-auto">
        <input type="date" id="from" class="form-control" />
    </div>
    <div class="col-auto">
        <input type="date" id="to" class="form-control" />
    </div>
    <div class="col-auto">
        <button type="button" id="btnRun" class="btn btn-primary">套用</button>
        <a id="btnExport" class="btn btn-outline-secondary">匯出 Excel</a>
    </div>
</form>

<canvas id="chart" height="120"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let chart;
    function buildUrl(base){
      const id = document.getElementById('reportId').value;
      const from = document.getElementById('from').value;
      const to = document.getElementById('to').value;
      const u = new URL(base, window.location.origin);
      u.searchParams.set('reportDefinitionId', id);
      if(from) u.searchParams.set('from', from);
      if(to) u.searchParams.set('to', to);
      return u.toString();
    }

    async function run(){
      const res = await fetch(buildUrl('@Url.Action("Run", "Reports")'));
      const { labels, data } = await res.json();

      const ctx = document.getElementById('chart');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: '數值', data }] },
        options: { responsive: true, tension:.25 }
      });

      // 匯出連結
      document.getElementById('btnExport').href = buildUrl('@Url.Action("ExportExcel", "Reports")');
    }

    document.getElementById('btnRun').addEventListener('click', run);
    window.addEventListener('DOMContentLoaded', run);
</script>
